---
- name: Reaccionar a alerta de Prometheus
  hosts: localhost
  gather_facts: false
  vars:
    alert: {}
  tasks:
    - name: Log de la alerta
      ansible.builtin.debug:
        msg: >
          Recibida alerta {{ source }} - alert: {{ alert }}
     #     en instancia {{ alert.payload.instance }}

    # Ejemplos de acciones:
    - name: Si TargetDown cr√≠tico, intentar reiniciar Deployment en OpenShift
     # when: "(alert.alerts|first).labels.alertname == 'TargetDown' and (alert.alerts|first).labels.severity == 'critical'"
      ansible.builtin.shell: |
        oc --token {{ token }} --server {{ server }} --insecure-skip-tls-verify={{ insecure-skip-tls-verify }} rollout restart deploy/mini-repo -n demo-eda
      changed_when: true
      vars:
      server: "{{ lookup('ansible.builtin.env', 'K8S_AUTH_HOST') }}"
      token: "{{ lookup('ansible.builtin.env', 'K8S_AUTH_API_KEY') }}"
      insecure-skip-tls-verify: "{{ not lookup('ansible.builtin.env', 'K8S_AUTH_VERIFY_SSL', default='false') }}"

